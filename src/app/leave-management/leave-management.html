<div class="container-fluid p-4">
  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="fw-bold mb-0">Leave Management</h4>
    </div>

    <div class="d-flex gap-2">
      <input
        type="text"
        class="form-control"
        style="width: 220px"
        placeholder="Search leaves..."
        [(ngModel)]="searchText"
        (input)="applySearchAndPagination()"
      />

      @if (user.role === 'STAFF') {
      <button class="btn btn-primary" (click)="showApplyForm = !showApplyForm">Apply Leave</button>
      }
    </div>
  </div>

  <!-- APPLY LEAVE FORM -->
  @if (showApplyForm) {
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold">Apply New Leave</div>

    <div class="card-body">
      <form [formGroup]="leaveForm" (ngSubmit)="applyLeave()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">From Date</label>
            <input type="date" class="form-control" formControlName="fromDate" />
          </div>

          <div class="col-md-4">
            <label class="form-label">To Date</label>
            <input type="date" class="form-control" formControlName="toDate" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Reason</label>
            <input class="form-control" formControlName="reason" />
          </div>
        </div>

        <div class="mt-3 text-end">
          <button class="btn btn-success px-4" type="submit">Submit</button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- LEAVE TABLE -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Sr No</th>
            @if (user.role === 'HOD'){
            <th>Staff Name</th>
            }
            <th>From</th>
            <th>To</th>
            <th>Reason</th>
            <th>Status</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>

        <tbody>
          @for (leave of pagedLeaves; track leave.id; let i = $index) {
          <tr>
            <td>{{ (page - 1) * pageSize + i + 1 }}</td>
            @if (user.role === 'HOD'){
            <td>{{ leave.staffName }}</td>
            }
            <td>{{ leave.fromDate | date : 'dd-MM-yyyy' }}</td>
            <td>{{ leave.toDate | date : 'dd-MM-yyyy' }}</td>
            <td>{{ leave.reason }}</td>

            <td>
              <span
                class="badge"
                [class.bg-warning]="leave.status === 'PENDING'"
                [class.bg-success]="leave.status === 'APPROVED'"
                [class.bg-danger]="leave.status === 'REJECTED'"
              >
                {{ leave.status }}
              </span>
            </td>

            <td class="text-center">
              <button
                class="btn btn-sm btn-outline-primary me-1"
                data-bs-toggle="modal"
                data-bs-target="#viewLeaveModal"
                (click)="viewLeave(leave)"
              >
                View
              </button>

              @if (user.role === 'HOD' && leave.status === 'PENDING') {
              <button
                class="btn btn-sm btn-success me-1"
                data-bs-toggle="modal"
                data-bs-target="#confirmLeaveModal"
                (click)="openConfirmModal(leave, 'APPROVED')"
              >
                Approve
              </button>

              <button
                class="btn btn-sm btn-danger"
                data-bs-toggle="modal"
                data-bs-target="#confirmLeaveModal"
                (click)="openConfirmModal(leave, 'REJECTED')"
              >
                Reject
              </button>
              }
            </td>
          </tr>
          } @if (pagedLeaves.length === 0) {
          <tr>
            <td colspan="6" class="text-center text-muted py-4">No leaves found</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINATION -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-outline-secondary" (click)="prev()" [disabled]="page === 1">
      ← Previous
    </button>

    <span class="text-muted"> Page {{ page }} of {{ totalPages }} </span>

    <button class="btn btn-outline-secondary" (click)="next()" [disabled]="page === totalPages">
      Next →
    </button>
  </div>
</div>

<!-- VIEW LEAVE MODAL -->
<div class="modal fade" id="viewLeaveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Leave Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      @if (selectedLeave) {
      <div class="modal-body">
        <p><b>From:</b> {{ selectedLeave.fromDate | date : 'dd-MM-yyyy' }}</p>
        <p><b>To:</b> {{ selectedLeave.toDate | date : 'dd-MM-yyyy' }}</p>
        @if (user.role === 'HOD'){
        <p><b>Staff Name:</b> {{ selectedLeave.staffName }}</p>
        }
        <p><b>Reason:</b> {{ selectedLeave.reason }}</p>
        <p><b>Status:</b> {{ selectedLeave.status }}</p>
      </div>
      }
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal fade" id="confirmLeaveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Action</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      @if (selectedLeave && pendingAction) {
      <div class="modal-body">
        Are you sure you want to
        <b>{{ pendingAction }}</b>
        the leave from
        <b>{{ selectedLeave.fromDate | date : 'dd-MM-yyyy' }}</b>
        to
        <b>{{ selectedLeave.toDate | date : 'dd-MM-yyyy' }}</b
        >?
      </div>
      }

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button
          class="btn"
          [class.btn-success]="pendingAction === 'APPROVED'"
          [class.btn-danger]="pendingAction === 'REJECTED'"
          data-bs-dismiss="modal"
          (click)="confirmAction()"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>
