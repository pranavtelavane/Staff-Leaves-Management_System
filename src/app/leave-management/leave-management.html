<div class="container-fluid p-4 bg-light min-vh-100">
  <!-- HEADER -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h4 class="fw-bold mb-0">Leave Management</h4>
        <small class="text-muted">
          @if (user.role === 'HOD') { Review and manage staff leaves } @else { Track and apply for
          leaves }
        </small>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <input
          type="text"
          class="form-control form-control-sm"
          style="width: 220px"
          placeholder="Search leaves..."
          [(ngModel)]="searchText"
          (input)="applySearchAndPagination()"
        />

        @if (user.role === 'STAFF') {
        <button class="btn btn-primary btn-sm" (click)="showApplyForm = !showApplyForm">
          + Apply Leave
        </button>
        }
      </div>
    </div>
  </div>

  <!-- APPLY LEAVE FORM -->
  @if (showApplyForm) {
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-semibold">Apply New Leave</div>

    <div class="card-body">
      <form [formGroup]="leaveForm" (ngSubmit)="applyLeave()">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">From Date</label>
            <input
              type="date"
              class="form-control"
              formControlName="fromDate"
              [class.is-invalid]="
                leaveForm.get('fromDate')?.invalid && leaveForm.get('fromDate')?.touched
              "
            />
            @if (leaveForm.get('fromDate')?.touched &&
            leaveForm.get('fromDate')?.hasError('required')) {
            <div class="text-danger small">Please select a fromDate</div>
            }
          </div>

          <div class="col-md-4">
            <label class="form-label">To Date</label>
            <input
              type="date"
              class="form-control"
              formControlName="toDate"
              [class.is-invalid]="
                leaveForm.get('toDate')?.invalid && leaveForm.get('toDate')?.touched
              "
            />
            @if (leaveForm.get('toDate')?.touched && leaveForm.get('toDate')?.hasError('required'))
            {
            <div class="text-danger small">Please select a toDate</div>
            }
          </div>

          <div class="col-md-4">
            <label class="form-label">Reason</label>
            <input
              class="form-control"
              formControlName="reason"
              [class.is-invalid]="
                leaveForm.get('reason')?.invalid && leaveForm.get('reason')?.touched
              "
            />
            @if (leaveForm.get('reason')?.touched && leaveForm.get('reason')?.hasError('required'))
            {
            <div class="text-danger small">Please enter a reason</div>
            }
          </div>
        </div>

        <div class="mt-3 text-end">
          <button class="btn btn-success btn-sm px-4" type="submit">Submit</button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- LEAVE TABLE -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Sr No</th>

            @if (user.role === 'HOD') {
            <th>Staff Name</th>
            }

            <th>From</th>
            <th>To</th>
            <th>Reason</th>
            <th>Status</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>

        <tbody>
          @for (leave of pagedLeaves; track leave.id; let i = $index) {
          <tr>
            <td>{{ (page - 1) * pageSize + i + 1 }}</td>

            @if (user.role === 'HOD') {
            <td class="fw-semibold">{{ leave.staffName }}</td>
            }

            <td>{{ leave.fromDate | date : 'dd-MM-yyyy' }}</td>
            <td>{{ leave.toDate | date : 'dd-MM-yyyy' }}</td>
            <td>{{ leave.reason }}</td>

            <td>
              <span
                class="badge"
                [class.bg-warning]="leave.status === 'PENDING'"
                [class.bg-success]="leave.status === 'APPROVED'"
                [class.bg-danger]="leave.status === 'REJECTED'"
              >
                {{ leave.status }}
              </span>
            </td>

            <td class="text-center">
              <button
                class="btn btn-sm btn-outline-primary me-1"
                data-bs-toggle="modal"
                data-bs-target="#viewLeaveModal"
                (click)="viewLeave(leave)"
              >
                View
              </button>

              @if (user.role === 'HOD' && leave.status === 'PENDING') {
              <button
                class="btn btn-sm btn-success me-1"
                data-bs-toggle="modal"
                data-bs-target="#confirmLeaveModal"
                (click)="openConfirmModal(leave, 'APPROVED')"
              >
                Approve
              </button>

              <button
                class="btn btn-sm btn-danger"
                data-bs-toggle="modal"
                data-bs-target="#confirmLeaveModal"
                (click)="openConfirmModal(leave, 'REJECTED')"
              >
                Reject
              </button>
              }
            </td>
          </tr>
          } @if (pagedLeaves.length === 0) {
          <tr>
            <td colspan="7" class="text-center text-muted py-4">No leaves found</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINATION -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-outline-secondary btn-sm" (click)="prev()" [disabled]="page === 1">
      ← Previous
    </button>

    <span class="text-muted small"> Page {{ page }} of {{ totalPages }} </span>

    <button
      class="btn btn-outline-secondary btn-sm"
      (click)="next()"
      [disabled]="page === totalPages"
    >
      Next →
    </button>
  </div>
</div>

<!-- VIEW LEAVE MODAL -->
<div class="modal fade" id="viewLeaveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content shadow-lg border-0">
      <!-- HEADER -->
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">Leave Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- BODY -->
      @if (selectedLeave) {
      <div class="modal-body px-4 py-3">
        <div class="row mb-3">
          <div class="col-md-6">
            <small class="text-muted">From Date</small>
            <div class="fw-semibold">
              {{ selectedLeave.fromDate | date : 'dd-MM-yyyy' }}
            </div>
          </div>

          <div class="col-md-6">
            <small class="text-muted">To Date</small>
            <div class="fw-semibold">
              {{ selectedLeave.toDate | date : 'dd-MM-yyyy' }}
            </div>
          </div>
          <!-- </div> -->

          @if (user.role === 'HOD') {
          <div class="col-md-6">
            <small class="text-muted">Staff Name</small>
            <div class="fw-semibold">
              {{ selectedLeave.staffName }}
            </div>
          </div>
          }

          <div class="col-md-6">
            <small class="text-muted">Reason</small>
            <div class="fw-semibold">
              {{ selectedLeave.reason }}
            </div>
          </div>

          <div class="col-md-6">
            <small class="text-muted">Status</small>
            <div>
              <span
                class="badge px-3 py-2"
                [class.bg-warning]="selectedLeave.status === 'PENDING'"
                [class.bg-success]="selectedLeave.status === 'APPROVED'"
                [class.bg-danger]="selectedLeave.status === 'REJECTED'"
              >
                {{ selectedLeave.status }}
              </span>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- FOOTER -->
      <div class="modal-footer bg-light">
        <button class="btn btn-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal fade" id="confirmLeaveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Action</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      @if (selectedLeave && pendingAction) {
      <div class="modal-body">
        Are you sure you want to
        <b>{{ pendingAction }}</b>
        the leave from
        <b>{{ selectedLeave.fromDate | date : 'dd-MM-yyyy' }}</b>
        to
        <b>{{ selectedLeave.toDate | date : 'dd-MM-yyyy' }}</b
        >?
      </div>
      }

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button
          class="btn btn-sm"
          [class.btn-success]="pendingAction === 'APPROVED'"
          [class.btn-danger]="pendingAction === 'REJECTED'"
          data-bs-dismiss="modal"
          (click)="confirmAction()"
        >
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>
