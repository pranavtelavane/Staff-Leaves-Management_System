<div class="container-fluid p-4 bg-light min-vh-100">
  <!-- HEADER -->
  <div class="card shadow-sm mb-4">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div>
        <h4 class="fw-bold mb-0">Staff Management</h4>
        <small class="text-muted">Manage department staff members</small>
      </div>

      <div class="d-flex gap-2">
        <input
          type="text"
          class="form-control form-control-sm"
          style="width: 220px"
          placeholder="Search staff..."
          [(ngModel)]="searchText"
          (input)="applySearchAndSort()"
        />

        <button
          class="btn btn-primary btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#addStaffModal"
          (click)="openAddStaffModal()"
        >
          + Add Staff
        </button>
      </div>
    </div>
  </div>

  <!-- STAFF TABLE -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th (click)="sort('name')" class="sortable">Full Name</th>
            <th (click)="sort('username')" class="sortable">Username</th>
            <th (click)="sort('email')" class="sortable">Email</th>
            <th>Mobile</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>

        <tbody>
          @for (staff of pagedStaff; track staff.id) {
          <tr>
            <td class="fw-semibold">{{ staff.name | titlecase }}</td>
            <td>{{ staff.username }}</td>
            <td>{{ staff.email }}</td>
            <td>{{ staff.mobile }}</td>
            <td class="text-center">
              <button
                class="btn btn-sm btn-outline-primary me-1"
                data-bs-toggle="modal"
                data-bs-target="#viewStaffModal"
                (click)="viewStaff(staff)"
              >
                View
              </button>

              <button class="btn btn-sm btn-outline-danger" (click)="deleteStaff(staff.id)">
                Delete
              </button>
            </td>
          </tr>
          } @if (pagedStaff.length === 0) {
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No staff found</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINATION -->
  <div class="d-flex justify-content-between align-items-center mt-3">
    <button class="btn btn-outline-secondary btn-sm" (click)="prev()" [disabled]="page === 1">
      ← Previous
    </button>

    <span class="text-muted small"> Page {{ page }} of {{ totalPages }} </span>

    <button
      class="btn btn-outline-secondary btn-sm"
      (click)="next()"
      [disabled]="page === totalPages"
    >
      Next →
    </button>
  </div>
</div>

<!-- VIEW STAFF MODAL -->
<div class="modal fade" id="viewStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Staff Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      @if (selectedStaff) {
      <div class="modal-body text-center">
        <img
          [src]="selectedStaff.profilePhoto || defaultAvatar"
          (error)="onImgError($event)"
          class="rounded-circle mb-3"
          width="120"
          height="120"
        />

        <ul class="list-group list-group-flush text-start">
          <li class="list-group-item"><b>Name:</b> {{ selectedStaff.name | titlecase }}</li>
          <li class="list-group-item"><b>Username:</b> {{ selectedStaff.username }}</li>
          <li class="list-group-item"><b>Email:</b> {{ selectedStaff.email }}</li>
          <li class="list-group-item"><b>Mobile:</b> {{ selectedStaff.mobile }}</li>
          <li class="list-group-item"><b>Department:</b> {{ selectedStaff.department }}</li>
          <li class="list-group-item"><b>Role:</b> {{ selectedStaff.role }}</li>
        </ul>
      </div>
      }

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD STAFF MODAL -->
<div class="modal fade" id="addStaffModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Staff</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form [formGroup]="addStaffForm" (ngSubmit)="submitAddStaff()">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Name</label>
              <input
                class="form-control"
                formControlName="name"
                [class.is-invalid]="
                  addStaffForm.get('name')?.invalid && addStaffForm.get('name')?.touched
                "
              />
              @if (addStaffForm.get('name')?.touched &&
              addStaffForm.get('name')?.hasError('required')) {
              <div class="text-danger small">Name is required</div>
              } @if (addStaffForm.get('name')?.touched &&
              addStaffForm.get('name')?.hasError('pattern')) {
              <div class="text-danger small">Enter valid name</div>
              }
            </div>

            <div class="col-md-6">
              <label class="form-label">Username</label>
              <input
                class="form-control"
                formControlName="username"
                [class.is-invalid]="
                  addStaffForm.get('username')?.invalid && addStaffForm.get('username')?.touched
                "
              />
              @if (addStaffForm.get('username')?.touched &&
              addStaffForm.get('username')?.hasError('required')) {
              <div class="text-danger small">Username is required</div>
              } @if (addStaffForm.get('username')?.touched &&
              addStaffForm.get('username')?.hasError('pattern')) {
              <div class="text-danger small">Enter valid username</div>
              }
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input
                class="form-control"
                formControlName="email"
                [class.is-invalid]="
                  addStaffForm.get('email')?.invalid && addStaffForm.get('email')?.touched
                "
              />
              @if (addStaffForm.get('email')?.touched &&
              addStaffForm.get('email')?.hasError('required')) {
              <div class="text-danger small">Email is required</div>
              } @if (addStaffForm.get('email')?.touched &&
              addStaffForm.get('email')?.hasError('email')) {
              <div class="text-danger small">Enter valid email</div>
              }
            </div>

            <div class="col-md-6">
              <label class="form-label">Mobile</label>
              <input type="tel"
                class="form-control"
                formControlName="mobile"
                maxlength="10"
                [class.is-invalid]="
                  addStaffForm.get('mobile')?.invalid && addStaffForm.get('mobile')?.touched
                "
              />
              @if (addStaffForm.get('mobile')?.touched &&
              addStaffForm.get('mobile')?.hasError('required')) {
              <div class="text-danger small">Mobile number is required</div>
              } @if (addStaffForm.get('mobile')?.touched &&
              addStaffForm.get('mobile')?.hasError('pattern')) {
              <div class="text-danger small">Enter valid mobile number</div>
              }
            </div>

            <div class="col-md-6">
              <label class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                formControlName="password"
                [class.is-invalid]="
                  addStaffForm.get('password')?.invalid && addStaffForm.get('password')?.touched
                "
              />
              @if (addStaffForm.get('password')?.touched &&
              addStaffForm.get('password')?.hasError('required')) {
              <div class="text-danger small">Password is required</div>
              } @if (addStaffForm.get('password')?.touched &&
              addStaffForm.get('password')?.hasError('pattern')) {
              <div class="text-danger small">
                Password must contain at least 8 characters, including one letter, one number, and
                one special character
              </div>
              }
            </div>

            <div class="col-md-6">
              <label class="form-label">Profile Photo</label>
              <input
                type="file"
                class="form-control"
                accept="image/*"
                (change)="onPhotoSelect($event)"
              />
            </div>
          </div>

          @if (profilePreview) {
          <div class="text-center mt-3">
            <img [src]="profilePreview" width="100" height="100" class="rounded-circle border" />
          </div>
          }
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success btn-sm" type="submit">Add Staff</button>
        </div>
      </form>
    </div>
  </div>
</div>
